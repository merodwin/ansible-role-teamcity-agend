---

- name: create teamcity group
  become: yes
  group: name={{teamcity_group}} state=present

- name: create teamcity user
  become: yes
  user: name="{{teamcity_user}}" group={{teamcity_group}} state=present

- name: download teamcity
  get_url: url="https://{{ teamcity_host }}/update/buildAgent.zip" dest="{{download_directory}}/agent.zip" validate_certs=False

- name: create dir
  become: true
  file: path="{{agent_install_folder}}" state=directory owner="{{teamcity_user}}" group="{{teamcity_group}}" mode="777"

- name: check if service installed
  stat: path=/etc/systemd/system/teamcity-agent.service
  register: servicefile

- name: create service
  become: yes
  template: src=teamcity-agent.service.j2 dest=/etc/systemd/system/teamcity-agent.service owner=root mode=755


- name: shutdown agend
  service: name=teamcity-agent state=stopped
  when: servicefile.stat.exists == True

- name: install unzip
  become: true
  apt: name=unzip state=latest


- name: unzip teamcity-agent
  become: yes
  unarchive: src="{{download_directory}}/agent.zip" dest="{{agent_install_folder}}" copy=no



- name: create config
  become: yes
  template: src=buildAgent.properties.j2 dest="{{agent_install_folder}}/conf/buildAgent.properties"

- name: chown dir
  become: true
  file: path="{{agent_install_folder}}" state=directory owner="{{teamcity_user}}" group="{{teamcity_group}}" mode="755" recurse=yes

- name: start agend
  service: name=teamcity-agent state=started



